{% extends '/partials/_base.twig' %}

{% block content %}

    {% include 'partials/_nav.twig' with { 'colour': 'white', 'logo': 'logo.svg', 'navColour' : 'navy', 'includeDropdowns': true } %}

    {% include '/partials/header/_homeheader.twig' %}

    {% set blocks = entry.pageBuilder.all() %}

    {% for block in blocks %}
        {% include 'blocks/_'~block.type %}
    {% endfor %}


    <div class="bg-white formAndText border-light_grey border-t">
        <div class="max-w-screen-xl mx-auto py-24 px-4 sm:px-6 lg:px-8">
            <div class="w-5/6 mx-auto">
                <h2 class="text-navy text-3xl text-center lg:text-5xl mb-4 font-bold">
                    {{ callToAction.formTitle }}
                </h2>
                {{ callToAction.formDescription | markdown }}

                {% set form = craft.formie.forms({ handle: 'letSCollaborate' }).one() %}
                {% do craft.formie.registerAssets(form.handle) %}

                {# Fetch the current submission - if there is one #}
                {% set submission = form.getCurrentSubmission() %}
                {% set submitted = craft.formie.plugin.service.getFlash(form.id, 'submitted') %}

                {# Show any error or success messages for the submission #}
                {% set flashNotice = craft.formie.plugin.service.getFlash(form.id, 'notice') %}
                {% set flashError = craft.formie.plugin.service.getFlash(form.id, 'error') %}

                {% if flashNotice %}
                    <div role="alert">
                        {{ flashNotice | raw }}
                    </div>
                {% endif %}

                {% if flashError %}
                    <div role="alert">
                        {{ flashError | raw }}
                    </div>
                {% endif %}

                <form id="{{ form.formId }}" method="post" data-config="{{ form.configJson }}">
                    {{ csrfInput() }}
                    {{ actionInput('formie/submissions/submit') }}
                    {{ hiddenInput('handle', form.handle) }}

                    <div class="flex flex-col md:flex-row justify-between space-x-0 space-y-4 md:space-x-2 md:space-y-0">
                        {% for field in form.getFields() %}
                            {{ craft.formie.renderField(form, field) }}
                        {% endfor %}
                        <div class="fui-field w-full md:w-1/3">
                            <button class="w-full py-3 px-4 bg-navy text-sm uppercase tracking-widest text-white border border-white rounded font-bold" type="submit">Let's talk</button>
                        </div>
                    </div>
                </form>

            </div>
        </div>
    </div>

    
    <div class="bg-white flex flex-col lg:flex-row space-x-0 space-y-8 lg:space-y-0 lg:space-x-4">
        <div class="w-full w-1/2">
            <div id="map" class="google-map" style="min-height: 450px;width: 100%;">
                <div class="responsive-embed">
                </div><!-- /.responsive-embed -->
            </div><!-- /#map.google-map -->
        </div>
        <div class="w-full w-1/2">
            <div id="map2" class="google-map" style="min-height: 450px;width: 100%;">
                <div class="responsive-embed">
                </div><!-- /.responsive-embed -->
            </div><!-- /#map.google-map -->
        </div>
    </div>

    {% include 'partials/_nav.twig' with { 'colour': 'navy', 'logo': 'logo-white.svg', 'navColour' : 'white', 'includeDropdowns': false } %}

    <script src="https://unpkg.com/es6-promise@4.2.4/dist/es6-promise.auto.min.js"></script>
    <script src="https://unpkg.com/@mapbox/mapbox-sdk/umd/mapbox-sdk.min.js"></script>
    <script>

        mapboxgl.accessToken = 'pk.eyJ1Ijoicnlhbm53byIsImEiOiJja2VtbnlodW4wNWU1MnFsajQ1bTl2dnhvIn0.NMZP89hoKD1hVlPshKGY5g';
        var mapboxClient = mapboxSdk({ accessToken: mapboxgl.accessToken });

        let center;

        mapboxClient.geocoding
            .forwardGeocode({
                query: 'Cardiff, New South Wales',
                autocomplete: false,
                limit: 1
            })
            .send()
            .then(function(response) {
                if (
                    response &&
                    response.body &&
                    response.body.features &&
                    response.body.features.length
                ) {
                    var feature = response.body.features[0];

                    var map = new mapboxgl.Map({
                        container: 'map',
                        style: 'mapbox://styles/ryannwo/ckemo757h2hf419o5ninz69gx',
                        center: feature.center,
                        zoom: 14
                    });
                    map.scrollZoom.disable();
                    map.addControl(new mapboxgl.NavigationControl());

                    map.on('touchstart', function(){
                        map.dragging.disable();
                    });

                    map.on('load', function() {
                        map.loadImage(
                            '/assets/img/cardiff-icon.png',
                            function(error, image) {
                                if (error) throw error;
                                map.addImage('micotech', image);
                                map.addSource('point', {
                                    'type': 'geojson',
                                    'data': {
                                        'type': 'FeatureCollection',
                                        'features': [
                                            {
                                                'type': 'Feature',
                                                'geometry': {
                                                    'type': 'Point',
                                                    'coordinates': feature.center
                                                }
                                            }
                                        ]
                                    }
                                });
                                map.addLayer({
                                    'id': 'points',
                                    'type': 'symbol',
                                    'source': 'point',
                                    'layout': {
                                        'icon-image': 'micotech',
                                        'icon-size': 0.5
                                    }
                                });
                            }
                        );
                    });
                }
            });

        mapboxClient.geocoding
            .forwardGeocode({
                query: 'Mackay Queensland',
                autocomplete: false,
                limit: 1
            })
            .send()
            .then(function(response) {
                if (
                    response &&
                    response.body &&
                    response.body.features &&
                    response.body.features.length
                ) {
                    var feature = response.body.features[0];

                    var map = new mapboxgl.Map({
                        container: 'map2',
                        style: 'mapbox://styles/ryannwo/ckemo757h2hf419o5ninz69gx',
                        center: feature.center,
                        zoom: 14
                    });
                    map.scrollZoom.disable();
                    map.addControl(new mapboxgl.NavigationControl());

                    map.on('touchstart', function(){
                        map.dragging.disable();
                    });

                    map.on('load', function() {
                        map.loadImage(
                            '/assets/img/mackay-icon.png',
                            function(error, image) {
                                if (error) throw error;
                                map.addImage('micotech', image);
                                map.addSource('point', {
                                    'type': 'geojson',
                                    'data': {
                                        'type': 'FeatureCollection',
                                        'features': [
                                            {
                                                'type': 'Feature',
                                                'geometry': {
                                                    'type': 'Point',
                                                    'coordinates': feature.center
                                                }
                                            }
                                        ]
                                    }
                                });
                                map.addLayer({
                                    'id': 'points',
                                    'type': 'symbol',
                                    'source': 'point',
                                    'layout': {
                                        'icon-image': 'micotech',
                                        'icon-size': 0.5
                                    }
                                });
                            }
                        );
                    });
                }
            });
    </script>

{% endblock %}